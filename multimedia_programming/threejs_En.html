<!DOCTYPE html>
<html>
 <head>

    <meta charset=utf-8 />
	<meta name="description" content="Clara Peñalva's personal website" />
	<title>Clara Peñalva</title>	
	<link rel="shortcut icon" href="../pics/favicon.png"/>
</head>
<body>

	<script src="../js/Three.js"></script>
	<script src="../js/Detector.js"></script>
	<script src="../js/Stats.js"></script>
	<script src="../js/OrbitControls.js"></script>
	<script src="../js/THREEx.KeyboardState.js"></script>
	<script src="../js/THREEx.FullScreen.js"></script>
	<script src="../js/THREEx.WindowResize.js"></script>
	<script src="../fonts/helvetiker_bold.typeface.js"></script>
	<script src="../fonts/helvetiker_regular.typeface.js"></script>
	<!-- jQuery code to display an information button and box when clicked. -->
	<script src="../js/jquery-1.9.1.js"></script>
	<script src="../js/jquery-ui.js"></script>
	<script type='text/javascript' src='../js/Tween.js'></script>
	<link rel=stylesheet href="../css/jquery-ui.css" />
	<link rel=stylesheet href="../css/info.css"/>
	<script src="../js/info.js"></script>
	<!-- ------------------------------------------------------------ -->
	<div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div>
	<script type="text/javascript" language="javascript">
		// MAIN
		// standard global variables
		var container, scene, camera, renderer, controls, stats;
		var keyboard = new THREEx.KeyboardState();
		var clock = new THREE.Clock();

		// custom global variables
		var cube, cube2;
		var projector, mouse = { x: 0, y: 0 }, INTERSECTED, INTERSECTED2;
		
		//variables animación
		var rotation, rotation2;
		var target, target2;
		var tween = new TWEEN.Tween(rotation).to(target, 2000);
		var tween2 = new TWEEN.Tween(rotation2).to(target2, 2000);
		 	
		tween.onUpdate(function(){
			cube.rotation.x = rotation.x;
			cube.rotation.y = rotation.y;
		});
		tween.easing(TWEEN.Easing.Elastic.InOut);
		
		tween2.onUpdate(function(){
			cube2.rotation.x = rotation.x;
			cube2.rotation.y = rotation.y;
		});
		tween2.easing(TWEEN.Easing.Quartic.InOut);
		var seleccionada1 = false;
		var seleccionada2 = false;
		var ptosGanar;
		init();
		animate();
		
		var intersects;//array de intersecciones
		var textMesh, textMesh2, textMesh3; 
		var face1, face2, faceMostrada;
		var cambiado = false; //si se ha seleccionado un dado
		var unaVez = true; //para el texto de enhorabuena
		hayFace = false; //para el número de cara
		var vector, ray;
		// FUNCTIONS
		//número aleatorio
		function aleatorio(a,b) {
			return Math.round(Math.random()*(b-a)+parseInt(a));
		}
		
		function init() 
		{
			// SCENE
			scene = new THREE.Scene();
			// CAMERA
			var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
			var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
			camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
			scene.add(camera);
			camera.position.set(0,150,700);
			camera.lookAt(scene.position);	
			// RENDERER
			if ( Detector.webgl )
				renderer = new THREE.WebGLRenderer( {antialias:true} );
			else
				renderer = new THREE.CanvasRenderer(); 
			renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
			container = document.getElementById( 'ThreeJS' );
			container.appendChild( renderer.domElement );
			// EVENTS
			THREEx.WindowResize(renderer, camera);
			THREEx.FullScreen.bindKey({ charCode : 'm'.charCodeAt(0) });
			// CONTROLS
			controls = new THREE.OrbitControls( camera, renderer.domElement );
			// STATS
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.bottom = '0px';
			stats.domElement.style.zIndex = 100;
			container.appendChild( stats.domElement );
			// LIGHT
			var light = new THREE.PointLight(0xffffff);
			light.position.set(0,250,0);
			scene.add(light);
			// FLOOR
			var floorTexture = new THREE.ImageUtils.loadTexture( '../pics/prom/threejs/tableroThreejs.jpeg' );
			var floorMaterial = new THREE.MeshBasicMaterial( { map: floorTexture, side: THREE.DoubleSide } );
			var floorGeometry = new THREE.PlaneGeometry(1000, 1000, 10, 10);
			var floor = new THREE.Mesh(floorGeometry, floorMaterial);
			floor.position.y = -0.5;
			floor.rotation.x = Math.PI / 2;
			scene.add(floor);
			// SKYBOX/FOG
			var skyBoxGeometry = new THREE.CubeGeometry( 10000, 10000, 10000 );
			var skyBoxMaterial = new THREE.MeshBasicMaterial( { color: 0xA9D0F5, side: THREE.BackSide } );
			var skyBox = new THREE.Mesh( skyBoxGeometry, skyBoxMaterial );
			scene.add(skyBox);
			
			////////////
			// CUSTOM //
			////////////
			//puntos aleatorios para ganar
			ptosGanar = aleatorio(2, 12);
			//valores iniciales
			face1 = 5;
			face2 = 3;
			
			var materialArray = [];
			materialArray.push(new THREE.MeshBasicMaterial( { map: THREE.ImageUtils.loadTexture( '../pics/prom/threejs/dado/Dice-Blue-1.png' ) }));
			materialArray.push(new THREE.MeshBasicMaterial( { map: THREE.ImageUtils.loadTexture( '../pics/prom/threejs/dado/Dice-Blue-2.png' ) }));
			materialArray.push(new THREE.MeshBasicMaterial( { map: THREE.ImageUtils.loadTexture( '../pics/prom/threejs/dado/Dice-Blue-3.png' ) }));
			materialArray.push(new THREE.MeshBasicMaterial( { map: THREE.ImageUtils.loadTexture( '../pics/prom/threejs/dado/Dice-Blue-4.png' ) }));
			materialArray.push(new THREE.MeshBasicMaterial( { map: THREE.ImageUtils.loadTexture( '../pics/prom/threejs/dado/Dice-Blue-5.png' ) }));
			materialArray.push(new THREE.MeshBasicMaterial( { map: THREE.ImageUtils.loadTexture( '../pics/prom/threejs/dado/Dice-Blue-6.png' ) }));
			var cubeMaterial = new THREE.MeshFaceMaterial(materialArray);
			
			var cubeGeometry = new THREE.CubeGeometry( 100, 100, 100 );
			cube = new THREE.Mesh( cubeGeometry, cubeMaterial );
			cube.position.set(-70,50,0);
			if(ptosGanar == 8){
				cube.rotation.set(Math.PI/2, Math.PI/2, 0);
				face1 = 3;
			}
			cube.id = "cube1";
			scene.add(cube);
			
			var cube2Geometry = new THREE.CubeGeometry( 100, 100, 100 );
			cube2 = new THREE.Mesh( cube2Geometry, cubeMaterial );
			cube2.position.set(70,50,0);
			cube2.rotation.set(Math.PI/2, Math.PI/2, 0);
			cube2.id = "cube2";
			scene.add(cube2);
			
			// add 3D text
			var materialFront = new THREE.MeshBasicMaterial( { color: 0x9154AE } );
			var materialSide = new THREE.MeshBasicMaterial( { color: 0x000000 } );
			var materialArrayText = [ materialFront, materialSide ];
			var textGeom = new THREE.TextGeometry( "Get " + ptosGanar + " points", 
			{
				size: 30, height: 4, curveSegments: 3,
				font: "helvetiker", weight: "bold", style: "normal",
				bevelThickness: 1, bevelSize: 2, bevelEnabled: true,
				material: 0, extrudeMaterial: 1
			});
			
			var textMaterial = new THREE.MeshFaceMaterial(materialArrayText);
			textMesh = new THREE.Mesh(textGeom, textMaterial );
			
			textGeom.computeBoundingBox();
			var textWidth = textGeom.boundingBox.max.x - textGeom.boundingBox.min.x;
			
			textMesh.position.set( -0.5 * textWidth, 150, 0);
			textMesh.name = "text";
			scene.add(textMesh);
			
			
			// initialize object to perform world/screen calculations
			projector = new THREE.Projector();
			
			// when the mouse moves, call the given function
	
			document.addEventListener( 'mousedown', onDocumentMouseDown, false );
			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
		}
		
		//variables de mouseMove
		var textGeom2;
		var mouse2 = {x:0, y:0};
		var vector2, ray2, 
		// initialize object to perform world/screen calculations
		projector2 = new THREE.Projector();
		var intersects2;//array de intersecciones
		var INTERSECTED2;
		function onDocumentMouseMove( event ){
			// update the mouse variable
			mouse2.x = ( event.clientX / window.innerWidth ) * 2 - 1;
			mouse2.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
			vector2 = new THREE.Vector3( mouse2.x, mouse2.y, 1 );
			projector2.unprojectVector( vector2, camera );
			// create a Ray with origin at the mouse position
			ray2 = new THREE.Raycaster( camera.position, vector2.sub( camera.position ).normalize() );
			// create an array containing all objects in the scene with which the ray intersects
			intersects2 = ray2.intersectObjects( scene.children );
			if ( intersects2.length > 0 )
			{
				INTERSECTED2 = intersects2[0].object;			
				if(INTERSECTED2==cube || INTERSECTED2==cube2)
				{                    
				    intersects2 = ray2.intersectObjects( scene.children );
					faceMostrada = intersects2[0].face.materialIndex + 1;
					if(textGeom2)
					{
					scene.remove(textMesh3);
					delete textGeom2;
					}
						
					// add 3D text
					var materialFront = new THREE.MeshBasicMaterial( { color: 0x9154AE } );
					var materialSide = new THREE.MeshBasicMaterial( { color: 0x000000 } );
					var materialArrayText = [ materialFront, materialSide ];
					textGeom2 = new THREE.TextGeometry( "Face "+ faceMostrada, 
					{
						size: 15, height: 4, curveSegments: 3,
						font: "helvetiker", weight: "normal", style: "normal",
						bevelThickness: 1, bevelSize: 2, bevelEnabled: true,
						material: 0, extrudeMaterial: 1
					});
					var textMaterial = new THREE.MeshFaceMaterial(materialArrayText);
					textMesh3 = new THREE.Mesh(textGeom2, textMaterial );
					
					textGeom2.computeBoundingBox();
					var textWidth = textGeom2.boundingBox.max.x - textGeom2.boundingBox.min.x;
					
					textMesh3.position.set( 200, 200, 150, 0 );
					textMesh3.name = "text3";
					scene.add(textMesh3);
					hayFace = true;
					
		
				}
				
				else // there are no intersections
				{
					// remove previous intersection object reference
					//     by setting current intersection object to "nothing"
					INTERSECTED2 = null;
					if(hayFace){
						scene.remove(textMesh3);
						hayFace = false;
					}
				}	
			}
			else{
				if(hayFace){
					scene.remove(textMesh3);
					hayFace = false;
				}
			}
		}
		function onDocumentMouseDown( event ) {
			
			// update the mouse variable
			mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
			mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
			vector = new THREE.Vector3( mouse.x, mouse.y, 1 );
			projector.unprojectVector( vector, camera );
			// create a Ray with origin at the mouse position
			var ray = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );
			// create an array containing all objects in the scene with which the ray intersects
			intersects = ray.intersectObjects( scene.children );
			if ( intersects.length > 0 )
			{
				INTERSECTED = intersects[0].object;			
				if(INTERSECTED==cube)
				{                    
				   seleccionada1 = true;
				}
				if(INTERSECTED==cube2)
				{					
					seleccionada2 = true;
				}
			}
			else // there are no intersections
			{
				// remove previous intersection object reference
				//     by setting current intersection object to "nothing"
				INTERSECTED = null;
			}
		}

		function animate() 
		{
			requestAnimationFrame(animate);
			render();		
			update();	
			if(face1+face2 == ptosGanar) 
				compruebaJugada();	
			
		}
		
		function update()
		{
			if(seleccionada1)
			{
				rotation = { x : cube.rotation.x, y: cube.rotation.y };   
				target = { x : Math.floor(Math.random() * 4)*(Math.PI/2.0) , y: Math.floor(Math.random() * 4)*(Math.PI/2.0) };
				tween = new TWEEN.Tween(rotation).to(target, Math.random()*1000 + 100);
				tween.easing(TWEEN.Easing.Elastic.InOut);
				tween.start();

				//se actualiza
				tween.onUpdate(function(){
					cube.rotation.x = rotation.x;
					cube.rotation.y = rotation.y;
				});
				cambiado = true;
				tween.onComplete(function(){
					var vector = new THREE.Vector3( mouse.x, mouse.y, 1 );
					projector.unprojectVector( vector, camera );
					// create a Ray with origin at the mouse position
					var ray = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );
					// create an array containing all objects in the scene with which the ray intersects
					intersects = ray.intersectObjects( scene.children );
					face1 = intersects[0].face.materialIndex + 1;
					seleccionada1 = false;
				});
			}
			if(seleccionada2){
				rotation2 = { x : cube2.rotation.x, y: cube2.rotation.y };
				target2 = { x : Math.floor(Math.random() * 4)*(Math.PI/2.0) , y: Math.floor(Math.random() * 4)*(Math.PI/2.0) };
				tween2 = new TWEEN.Tween(rotation2).to(target2, Math.random()*1000 + 100);
				tween2.easing(TWEEN.Easing.Quartic.InOut);
				tween2.start();
				//se actualiza
				tween2.onUpdate(function(){
					 cube2.rotation.x = rotation2.x;
					 cube2.rotation.y = rotation2.y;
				});
				tween2.onComplete(function(){
					var vector = new THREE.Vector3( mouse.x, mouse.y, 1 );
					projector.unprojectVector( vector, camera );
					// create a Ray with origin at the mouse position
					var ray = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );
					// create an array containing all objects in the scene with which the ray intersects
					intersects = ray.intersectObjects( scene.children );
					face2 = intersects[0].face.materialIndex + 1;
					seleccionada2 = false;
				});
				cambiado = true;
			}
			TWEEN.update();			
			controls.update();
			stats.update();
		}
		
		function compruebaJugada(){
			//se comprueba si ha ganado
			cambiado = false;
			//cambiar texto			
			// add 3D text
			var materialFront = new THREE.MeshBasicMaterial( { color: 0x9154AE } );
			var materialSide = new THREE.MeshBasicMaterial( { color: 0x000000 } );
			var materialArrayText = [ materialFront, materialSide ];
			var textGeom = new THREE.TextGeometry( "Congratulations, you have won!", 
			{
				size: 30, height: 4, curveSegments: 3,
				font: "helvetiker", weight: "bold", style: "normal",
				bevelThickness: 1, bevelSize: 2, bevelEnabled: true,
				material: 0, extrudeMaterial: 1
			});
			if(unaVez){
			var textMaterial = new THREE.MeshFaceMaterial(materialArrayText);
			textMesh2 = new THREE.Mesh(textGeom, textMaterial );
			
			textGeom.computeBoundingBox();
			var textWidth = textGeom.boundingBox.max.x - textGeom.boundingBox.min.x;
			
			textMesh2.position.set( -0.5 * textWidth, 4, 200 );
			textMesh2.name = "text2";
			scene.add(textMesh2);
			document.removeEventListener( 'mousedown', onDocumentMouseDown, false );
			document.addEventListener( 'mousedown', reiniciar, false );
			unaVez = false;
			}
		}
		
		
		function reiniciar(){
			//puntos aleatorios para ganar
			ptosGanar = aleatorio(2, 12);
			cube.rotation.set(0, 0, 0);
			//valores iniciales
			if(ptosGanar == 8){
				cube.rotation.set(Math.PI/2, Math.PI/2,0);
				face1 = 3;
			}
			else	
				face1 = 5;
			cube2.rotation.set(Math.PI/2, Math.PI/2, 0);
			face2 = 3;
			
			scene.remove(textMesh);
			scene.remove(textMesh2);
			// add 3D text
			var materialFront = new THREE.MeshBasicMaterial( { color: 0x9154AE } );
			var materialSide = new THREE.MeshBasicMaterial( { color: 0x000000 } );
			var materialArrayText = [ materialFront, materialSide ];
			var textGeom = new THREE.TextGeometry( "Get " + ptosGanar + " points", 
			{
				size: 30, height: 4, curveSegments: 3,
				font: "helvetiker", weight: "bold", style: "normal",
				bevelThickness: 1, bevelSize: 2, bevelEnabled: true,
				material: 0, extrudeMaterial: 1
			});
			
			var textMaterial = new THREE.MeshFaceMaterial(materialArrayText);
			textMesh = new THREE.Mesh(textGeom, textMaterial );
			
			textGeom.computeBoundingBox();
			var textWidth = textGeom.boundingBox.max.x - textGeom.boundingBox.min.x;
			
			textMesh.position.set( -0.5 * textWidth, 150, 0);
			textMesh.name = "text";
			scene.add(textMesh);
			unaVez = true;
			document.removeEventListener( 'mousedown', reiniciar, false );		
			document.addEventListener( 'mousedown', onDocumentMouseDown, false );
		
		}
		
		function render() 
		{
			renderer.render( scene, camera );
		}

	</script>
</body>
</html>
